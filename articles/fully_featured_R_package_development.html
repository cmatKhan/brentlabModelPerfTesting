<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="brentlabModelPerfTesting">
<title>fully_featured_R_package_development • brentlabModelPerfTesting</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="fully_featured_R_package_development">
<meta property="og:description" content="brentlabModelPerfTesting">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">brentlabModelPerfTesting</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Usage.html">Usage</a>
    <a class="dropdown-item" href="../articles/Using_Package_Data.html">Using_Package_Data</a>
    <a class="dropdown-item" href="../articles/fully_featured_R_package_development.html">fully_featured_R_package_development</a>
    <a class="dropdown-item" href="../articles/performance_testing_xgboost_on_htcf.html">performance_testing_xgboost_on_htcf</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>fully_featured_R_package_development</h1>
            
      
      
      <div class="d-none name"><code>fully_featured_R_package_development.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="user-setup">User setup<a class="anchor" aria-label="anchor" href="#user-setup"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>At an absolute minimum, read Hadley Wickam and Jenny Bryan’s R
packages’ section <a href="https://r-pkgs.org/whole-game.html" class="external-link">The Whole
Game</a>.</p></li>
<li><p>You should also at the very least skim through the rest of that
book. You’ll use it as a reference frequently and you need to know what
is there.</p></li>
<li><p>After skimming the the Wickam/Bryan R packages book section on
documentation, also skim the <a href="https://roxygen2.r-lib.org/" class="external-link">Roxygen2 documentation</a>.
Documenting your code is important, and easier done as you write than
leaving it to later.</p></li>
<li><p>Finally, you need to be aware of the common code style standards.
You can choose the break the rules, but you should do this for a reason,
not due to ignorance of common conventions. I would suggest looking at
either the <a href="https://style.tidyverse.org/" class="external-link">tidyverse style
guide</a> or the <a href="https://google.github.io/styleguide/Rguide.html" class="external-link">Google R style
guide</a>. These two are <em>almost</em> exactly the same. For instance,
they both reference the other as a source.</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="system-requirements">System Requirements:<a class="anchor" aria-label="anchor" href="#system-requirements"></a>
</h2>
<ul>
<li><p>Up to date R</p></li>
<li><p>up to date Rstudio</p></li>
<li><p>Up to date <code>usethis</code> (the main R development tools
meta-package)</p></li>
<li><p>Up to date <code>renv</code> (similar to python <code>venv</code>
in function, though not seemingly in its conventions or
implementation)</p></li>
<li><p>I make a directory called <code>code</code> and
<code>projects</code> in my <code>$HOME</code>. I typically put projects
which I intend to be packaged, or src code that I pull from the
internet, in <code>code</code>, and projects which are more strictly
focused on analysis and are not going to be formally packaged in
<code>projects</code></p></li>
<li>
<p>Set up your Rstudio environment</p>
<ul>
<li>Open Rstudio, go to Tools –&gt; Global options
<ul>
<li>Set your default working directory to a location thaty <em>you
choose</em> as opposed to the default. I set mine to
<code>$HOME/projects</code>.</li>
<li>Uncheck the boxes – probably right underneath the default directory
setting box – that say anything along the lines of “Save session data on
exit” or “save Rdata automatically”, … – anything like that, turn it
off.</li>
<li>Go to the Appearance tab. I prefer the <code>Ubuntu mono</code>
<strong>editor font</strong>, and the <code>Tomorrow night</code>
<strong>editor theme</strong>. This also isn’t necessary, but I find the
inverted color scheme to be <em>a lot</em> easier on my eyes.</li>
<li>You’re going to spend a good amount of time in Rstudio – look around
the rest of the options, eg the window arrangement tab, and see what you
can customize to your own preferences.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Exit Rstudio, and re-launch it – now if you do <code><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd()</a></code>,
you’ll see that Rstudio launches by default in the location of your
choice, and looks better.</p>
</div>
<div class="section level2">
<h2 id="create-the-package-skeleton">Create the package skeleton<a class="anchor" aria-label="anchor" href="#create-the-package-skeleton"></a>
</h2>
<p>Despite preferring <code>$HOME/projects</code> be my default launch
location, I’m going to make this project – since it is intended to be
packaged software – in my <code>$HOME/code</code> directory. Create the
project skeleton with <code>usethis</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># note: the name of the package will be the basename of this path.</span></span>
<span><span class="co"># I am putting this in my $HOME/code directory</span></span>
<span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/create_package.html" class="external-link">create_package</a></span><span class="op">(</span><span class="st">'~/code/brentlabModelPerfTesting'</span><span class="op">)</span></span></code></pre></div>
<p>This will launch a new window where the
<code>current working directory</code> is set to the path you specified.
You can see this in the top right corner of your Rstudio session.</p>
</div>
<div class="section level2">
<h2 id="set-up-a-bunch-of-boilerplate">Set up a bunch of boilerplate<a class="anchor" aria-label="anchor" href="#set-up-a-bunch-of-boilerplate"></a>
</h2>
<p>Next, we’re going to set up a bunch of ‘boilerplate’ package code</p>
<div class="section level3">
<h3 id="add-a-readme-md-file">Add a README.md file<a class="anchor" aria-label="anchor" href="#add-a-readme-md-file"></a>
</h3>
<ul>
<li>
<code><a href="https://usethis.r-lib.org/reference/use_readme_rmd.html" class="external-link">usethis::use_readme_md()</a></code> (or
<code>use_readme_rmd</code> if you wish. I prefer <code>md</code> b/c it
is simpler)</li>
</ul>
<div class="section level4">
<h4 id="also-add-an-index-md">Also add an index.md<a class="anchor" aria-label="anchor" href="#also-add-an-index-md"></a>
</h4>
<ul>
<li>This is for your pkgdown documentation – the README.md will be
displayed on github, but <code>pkgdown</code> will use the
<code>index.md</code> file preferentially for its own homepage – this
way your documentation homepage can be different than your github
homepage README. No need to do anything with this now, though you could
put a ‘hello world’ line in (this is just a markdown document) if you
want</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="add-a-license">Add a license<a class="anchor" aria-label="anchor" href="#add-a-license"></a>
</h3>
<ul>
<li>Set up the license – you can read about licenses if you want. I
generally use the MIT license, which is intended to be as permissive as
possible. This is just considered good practice, and it is easily done:
<code><a href="https://usethis.r-lib.org/reference/licenses.html" class="external-link">usethis::use_mit_license()</a></code>. You should look at the other
licenses available, eg <code>use_gnu_license()</code>, if you care about
these things.</li>
</ul>
</div>
<div class="section level3">
<h3 id="update-the-initial-description-fields">Update the initial DESCRIPTION fields<a class="anchor" aria-label="anchor" href="#update-the-initial-description-fields"></a>
</h3>
<ul>
<li>Update your author, title and description fields in the
<code>DESCRIPTION</code> file</li>
</ul>
</div>
<div class="section level3">
<h3 id="start-your-virtual-environment">Start your virtual environment<a class="anchor" aria-label="anchor" href="#start-your-virtual-environment"></a>
</h3>
<ul>
<li><p><code><a href="https://rstudio.github.io/renv/reference/init.html" class="external-link">renv::init()</a></code>. Note: <a href="https://rstudio.github.io/renv/" class="external-link">renv</a> is not nearly as
intuitive and simple as python <code>venv</code>. It is your
responsibility to learn how to use <code>renv</code>, and you should
expect that you’re going to need to spend time doing that. An
alternative to <code>renv</code> is <code>packrat</code>, though
Posit/Rstudio seems to have chosen <code>renv</code> as the main virtual
environment management platform.</p></li>
<li><p>Frequently check <code><a href="https://rstudio.github.io/renv/reference/status.html" class="external-link">renv::status()</a></code> and frequently
<code><a href="https://rstudio.github.io/renv/reference/snapshot.html" class="external-link">renv::snapshot()</a></code> and if necessarily
<code>renv::install('some package')</code>. Note that this happens
<em>in addition to</em> using
<code>usethis::use_package('package', type='&lt;type&gt;', min_version = &lt;TRUE/&lt;specific_version&gt;&gt;)</code>.
It is critical that you figure out the difference between these two –
read the documentation first, play around with it on your own, and if
you have questions, post a question on the appropriate boards (see the
documentation for <code>usethis</code> and <code>renv</code>. It tells
you where to ask questions).</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="gitgithub">Git/github<a class="anchor" aria-label="anchor" href="#gitgithub"></a>
</h3>
<p><strong><em>Note</em></strong>: everything you add to your
<code>.gitignore</code>, you may also want to add to
<code>.Rbuildignore</code> and eventually <code>.dockerignore</code></p>
<ul>
<li><p>In your package, in the console, do
<code><a href="https://usethis.r-lib.org/reference/use_git.html" class="external-link">usethis::use_git()</a></code></p></li>
<li>
<p>go to <a href="https://github.com/github/gitignore" class="external-link">this repo
maintained by Github itself</a> and copy/paste (or wget or whatever)
this <a href="https://github.com/github/gitignore/blob/main/R.gitignore" class="external-link">R
project .gitignore template</a> into your project
<code>.gitignore</code> file</p>
<ul>
<li>It doesn’t really matter, but just look through the
<code>.gitignore</code> now and remove any duplicates from the items
that <code>usethis</code> includes by default. I also at this point add
a <code>tmp</code> directory in my package workspace, in which I’ll
store temporary development data, scripts, etc on my local, but that I
don’t want version controlled or pushed to github, and add that to the
<code>.gitignore</code>.</li>
<li>add a directory, <code>docs/</code> to your .gitignore</li>
<li>
<strong><em>Note</em></strong>: You can also add this .gitignore
template when you create the git repo through their interface.</li>
</ul>
</li>
<li>
<p>Go to your github account and create a repo. I would name the
repo the same name as the package, though this is not required.</p>
<ul>
<li>Follow the directions on git to add your local repo to github</li>
</ul>
</li>
<li><p>You can, but I don’t yet make my first push – I do the following
first</p></li>
</ul>
<div class="section level4">
<h4 id="set-up-your-test-environment">Set up your test environment<a class="anchor" aria-label="anchor" href="#set-up-your-test-environment"></a>
</h4>
<ul>
<li><p>usethis::use_testthat()</p></li>
<li><p>Set up a basic function and test – there will be more in a later
section on how to do this. But, we just want to make sure that all this
boiler plate will actually run. Do the following:</p></li>
<li><p><code>usethis::use_r('init_function')</code> this will open a
file <code>R/init_function.R</code>. With that as your active window,
enter <code><a href="https://usethis.r-lib.org/reference/use_r.html" class="external-link">usethis::use_test()</a></code>, which will create a test for
<code>init_function</code>. <strong><em>Note</em></strong>: You don’t
need to write anything in the <code>init_function.R</code> script, and
once we have an actual function, we’re going to delete this. It just
needs to be here so that the test suite runs and passes (the test suite
fills a passing test by default)</p></li>
</ul>
</div>
<div class="section level4">
<h4 id="set-up-pkgdown-and-gh-pages">Set up pkgdown and gh-pages<a class="anchor" aria-label="anchor" href="#set-up-pkgdown-and-gh-pages"></a>
</h4>
<ul>
<li><p><code><a href="https://usethis.r-lib.org/reference/use_pkgdown.html" class="external-link">usethis::use_pkgdown_github_pages()</a></code> will create the
gh-pages branch on your github repo. This is where you documentation
will get built and served by github</p></li>
<li><p>If you didn’t already do it, add <code>docs/</code> to your
<code>.gitignore</code> – you don’t watch to VC the <code>docs/</code>
on your main branch.</p></li>
<li><p><strong><em>IMPORTANT</em></strong> In order to allow the github
action to update the gh-pages branch, you need to change a branch
security setting on github. On the github repo page, do the
following:</p></li>
</ul>
<p>Go to:</p>
<blockquote>
<p>Settings –&gt; Actions –&gt; general –&gt; Workflow permissions</p>
</blockquote>
<p>and set the permissions to ‘Read and Write’</p>
</div>
<div class="section level4">
<h4 id="set-up-the-initial-dockerfile">Set up the initial dockerfile<a class="anchor" aria-label="anchor" href="#set-up-the-initial-dockerfile"></a>
</h4>
<p>create a file called (by convention) <code>Dockerfile</code> and
(this is not convention – must be called this)
<code>.dockerignore</code>. Add anything to the
<code>.dockerignore</code> that you dont want included in the dockerfile
– use the <code>.github</code>, thoughtful sense, and maybe other
peoples’ <code>.dockerignore</code> files as guides.</p>
<p><strong>important</strong>: add <code>Dockerfile</code> to your
<code>.Rbuildignore</code>. I’m going to try to note when you should do
things like this, but I might miss some. You should be thinking about
what should be ignored where, <em>and</em>, when you do the package
build check (explained in a couple steps from now), forgetting to do
things like this will be caught. You can fix it at the
<code>check</code> step, too.</p>
<p>Here is the one I use. <strong>This should not be used
blindly</strong>. This guide is intended for sophisticated users. Read
the dockerfile, read the docker docs, go ahead and try this out, but if
something isn’t working for you, figure it out and debug now. If there
is a typo or improvement to this template/example, please submit a pull
request.</p>
<pre class="raw"><code># get the base image, the rocker/verse has R, RStudio and pandoc
FROM r-base
# Get and install system dependencies

ENV RENV_VERSION 0.16.0
RUN R -e "install.packages(c('remotes'), repos = c(CRAN = 'https://cran.wustl.edu'))"
RUN R -e "remotes::install_github('rstudio/renv@${RENV_VERSION}')"

# it would be a good idea to figure out what 
# each of these do. My method of dealing with this 
# is to reduce it, try installing, and then add 
# packages to deal with errors. I don't adjust this 
# as frequently as I should.
RUN  apt-get update &amp;&amp; \
     apt-get install -y --no-install-recommends \
      software-properties-common \
      dirmngr \
      wget \
        build-essential \
        libssl-dev \
        libxml2-dev \
      libcurl4-openssl-dev \
      libfontconfig1-dev \
      libharfbuzz-dev \
      libfribidi-dev \
      libtiff-dev


# Clean up
RUN apt-get autoremove -y

WORKDIR /project
COPY renv.lock renv.lock
COPY renv/ renv/

COPY .Rprofile .Rprofile
COPY renv/activate.R renv/activate.R
COPY renv/settings.dcf renv/settings.dcf

# note: update this path as necessary based no the r-base r version
# and what you make your WORKDIR
ENV R_LIBS /project/renv/library/R-4.2/x86_64-pc-linux-gnu

# Using renv takes a really, really long time. I don't know 
# renv terribly well, so it is possible that there are settings 
# that could reduce the time it takes to install.
RUN R -e "renv::restore()"

WORKDIR /project/src
COPY . .
WORKDIR /project
RUN R -e "renv::activate();renv::install('./src', dependencies = TRUE)"
RUN rm -rf src

##### METHOD 2 install from github releases using remotes::install_github #####
#
# You can skip the renv portion and just use remotes::install_github(..., dependencies=TRUE)
</code></pre>
<p>Now check that this can actually build the image. Debug if necessary.
You could do this from the Rstudio integrated terminal, but I do it in a
terminal on my system</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> <span class="op">&lt;</span>your dockerhub username<span class="op">&gt;</span>/brentlabmodelperftesting .</span></code></pre></div>
<p>If it works without error, great! No need to do anything else with
this now.</p>
</div>
<div class="section level4">
<h4 id="set-up-ci-for-the-build-check-documentation-construction-and-coverage">Set up CI for the build check, documentation construction, and
coverage<a class="anchor" aria-label="anchor" href="#set-up-ci-for-the-build-check-documentation-construction-and-coverage"></a>
</h4>
<p><a href="https://github.com/r-lib/actions/tree/v2/examples" class="external-link">this
page</a> is linked from <code><a href="https://usethis.r-lib.org/reference/github_actions.html" class="external-link">usethis::use_github_actions</a></code>, and
gives a full list of available pre-configured CI github actions jobs
that you can add to your project</p>
<ul>
<li>
<p>R CMD check and build on multiple operating systems</p>
<ul>
<li>Read the <code><a href="https://usethis.r-lib.org/reference/github_actions.html" class="external-link">?usethis::use_github_actions</a></code> documentation. If
you don’t know what CI is, go read about it and figure it out. If you
don’t konw what <code>R CMD Check</code> means, look it up in the
Wickam/Bryan R package book. Otherwise, choose your poison here.
<code>use_github_action_check_standard()</code> is likely generally the
one you want. In this case, I am only interested in testing the package
on linux, so I’m going to choose
<code>use_github_action_check_release()</code>
</li>
</ul>
</li>
<li><p>Add the R CMD Check badge:
<code><a href="https://usethis.r-lib.org/reference/github_actions.html" class="external-link">usethis::use_github_actions_badge()</a></code></p></li>
<li>
<p><code>usethis::use_coverage('codecov')</code> installs
<code>covr</code> to track test coverage of your code. This will have
some output as it installs, and the last bit is a badge that you should
add to your README.md and index.md if you wish</p>
<ul>
<li>After running the cmd above, run
<code>usethis::use_github_action("test-coverage")</code> so that the
coverage report is also run on all pushes/pulls to main</li>
</ul>
</li>
<li><p><code>usethis::use_github_actions('pkgdown')</code>:
Automatically build the docs on <code>gh-pages</code></p></li>
</ul>
</div>
<div class="section level4">
<h4 id="adjust-the-ci-to-work-with-renv">Adjust the CI to work with <code>renv</code><a class="anchor" aria-label="anchor" href="#adjust-the-ci-to-work-with-renv"></a>
</h4>
<p>In general, the default CI will work. But, if you do end up using
<code>renv</code> to handle some more complicated dependencies (e.g.,
the precompiled-with-gpu capability linux based <code>XGBoost</code>
distribution that we’ll be using), you’ll want to use <code>renv</code>
rather than <code>pak</code> to build your environment in the CI.</p>
<p>Go to the <code>.github/workflows</code> directory. Here is what my
files look like when using <code>renv</code> – each gets a similar
adjustment.</p>
<p><strong><em>Note</em></strong>: This guide is not for unsophisticated
users. Getting the virtual environment, the CI, the Dockerfile, etc work
are all tasks that require a level of understanding and ability that is
beyond the novice, and probably beyond the intermediate level. If this
doesn’t run for you, I will always consider a pull request to update and
fix the documentation. Otherwise, go figure it out on your own. There is
documentation for each one of these items, and there are help community
message boards. I am expecting that you don’t copy/paste this in
blindly, but that you actually look at this, and look at the
<code>usethis</code> default CI scripts, and understand what has been
changed.</p>
<div class="section level5">
<h5 id="r-cmd-check">R CMD Check<a class="anchor" aria-label="anchor" href="#r-cmd-check"></a>
</h5>
<pre class="raw"><code># Workflow derived from https://github.com/r-lib/actions/tree/v2/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

name: R-CMD-check

jobs:
  R-CMD-check:
    runs-on: ${{ matrix.config.os }}

    name: ${{ matrix.config.os }} (${{ matrix.config.r }})
    
    # note: I removed the DEV ubuntu release b/c it failed -- I'm not 
    # interested in this case in ensuring that this package runs on 
    # a dev branch of ubuntu
    strategy:
      fail-fast: false
      matrix:
        config:
          - {os: ubuntu-latest,   r: 'release'}
          - {os: ubuntu-latest,   r: 'oldrel-1'}

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes
      # this needs to be added 
      RENV_PATHS_ROOT: ~/.local/share/renv

    steps:

      - uses: actions/checkout@v3

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.config.r }}
          http-user-agent: ${{ matrix.config.http-user-agent }}
          use-public-rspm: true
     
     # setup-r-dependencies is removed !
     # instead, we're handling dependencies with renv
      - name: Cache packages
        uses: actions/cache@v1
        with:
          path: ${{ env.RENV_PATHS_ROOT }}
          key: ${{ runner.os }}-renv-${{ hashFiles('**/renv.lock') }}
          restore-keys: |
            ${{ runner.os }}-renv-
     
     # note! have to add the rcmdcheck install
      - name: Restore packages
        shell: Rscript {0}
        run: |
          if (!requireNamespace("renv", quietly = TRUE)) install.packages("renv")
          renv::restore()
          renv::install('rcmdcheck')

      - uses: r-lib/actions/check-r-package@v2
        with:
          upload-snapshots: true
</code></pre>
</div>
<div class="section level5">
<h5 id="pkgdown">pkgdown<a class="anchor" aria-label="anchor" href="#pkgdown"></a>
</h5>
<pre class="raw"><code># Workflow derived from https://github.com/r-lib/actions/tree/v2/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  release:
    types: [published]
  workflow_dispatch:

name: pkgdown

jobs:
  pkgdown:
    runs-on: ubuntu-latest
    # Only restrict concurrency for non-PR jobs
    concurrency:
      group: pkgdown-${{ github.event_name != 'pull_request' || github.run_id }}
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      RENV_PATHS_ROOT: ~/.local/share/renv
    steps:
      - uses: actions/checkout@v3

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Cache packages
        uses: actions/cache@v1
        with:
          path: ${{ env.RENV_PATHS_ROOT }}
          key: ${{ runner.os }}-renv-${{ hashFiles('**/renv.lock') }}
          restore-keys: |
            ${{ runner.os }}-renv-

      - name: Restore packages
        shell: Rscript {0}
        run: |
          if (!requireNamespace("renv", quietly = TRUE)) install.packages("renv")
          renv::restore()
          renv::install('.')

      - name: Build site
        run: pkgdown::build_site_github_pages(new_process = FALSE, install = FALSE)
        shell: Rscript {0}

      - name: Deploy to GitHub pages 🚀
        if: github.event_name != 'pull_request'
        uses: JamesIves/github-pages-deploy-action@v4.4.1
        with:
          clean: false
          branch: gh-pages
          folder: docs</code></pre>
</div>
<div class="section level5">
<h5 id="coverage">coverage<a class="anchor" aria-label="anchor" href="#coverage"></a>
</h5>
<pre class="raw"><code># Workflow derived from https://github.com/r-lib/actions/tree/v2/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

name: test-coverage

jobs:
  test-coverage:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      RENV_PATHS_ROOT: ~/.local/share/renv

    steps:
      - uses: actions/checkout@v3

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Cache packages
        uses: actions/cache@v1
        with:
          path: ${{ env.RENV_PATHS_ROOT }}
          key: ${{ runner.os }}-renv-${{ hashFiles('**/renv.lock') }}
          restore-keys: |
            ${{ runner.os }}-renv-

      - name: Restore packages
        shell: Rscript {0}
        run: |
          if (!requireNamespace("renv", quietly = TRUE)) install.packages("renv")
          renv::restore()

      - name: Test coverage
        run: |
          covr::codecov(
            quiet = FALSE,
            clean = FALSE,
            install_path = file.path(Sys.getenv("RUNNER_TEMP"), "package")
          )
        shell: Rscript {0}

      - name: Show testthat output
        if: always()
        run: |
          ## --------------------------------------------------------------------
          find ${{ runner.temp }}/package -name 'testthat.Rout*' -exec cat '{}' \; || true
        shell: bash

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-test-failures
          path: ${{ runner.temp }}/package
</code></pre>
</div>
</div>
<div class="section level4">
<h4 id="important-snapshot-your-local-environment">
<strong><em>IMPORTANT</em></strong> snapshot your local
environment<a class="anchor" aria-label="anchor" href="#important-snapshot-your-local-environment"></a>
</h4>
<p>Now you need to update your virtual environment</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># shows what you've installed locally for this environment</span></span>
<span><span class="fu">renv</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/renv/reference/status.html" class="external-link">status</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># creates the lockfile</span></span>
<span><span class="fu">renv</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/renv/reference/snapshot.html" class="external-link">snapshot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="check-your-main-branch-locally">Check your main branch locally<a class="anchor" aria-label="anchor" href="#check-your-main-branch-locally"></a>
</h4>
<ul>
<li><p>Review your <code>.Rbuildignore</code> and make sure you have
ignored what you need to ignore. Hidden files I believe are ignored by
default – you should check that in the docs – but, if you made a
<code>tmp</code> directory, you should add that to your
<code>.Rbuildignore</code>.</p></li>
<li>
<p>Go to the “Build” tab in your “Environment” window in Rstudio.
Click the “Check” button. This runs <code>devtools::check()</code>
(comes along with <code>usethis</code>), which under the hood runs
<code>R CMD check</code>. This * should * run quickly and have
<strong>NO</strong> errors or warnings, since we haven’t installed
anything. If there are errors or warnings, you need to stop and fix
that.</p>
<ul>
<li>If you haven’t developed an R package before, or have never used
this button, get used to it. You should be clicking this
<em>frequently</em> as you develop, even though it does take some time
to execute.</li>
</ul>
</li>
<li>
<p>git add, commit, and push to main</p>
<ul>
<li>
<strong><em>Note</em></strong>: make sure you add the hidden files
which are not in your <code>.gitignore</code>, such as
<code>.Rprofile</code>, <code>.github</code>, <code>.Rbuildignore</code>
and <code>.gitignore</code>
</li>
</ul>
</li>
<li><p>go to github, click the “Actions” tab, and make sure that each of
these CI actions actually runs. If it doens’t run now, with a completely
empty package, it will be easier to fix now than it will be
later.</p></li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="create-a-dev-branch-and-develop">Create a dev branch and develop<a class="anchor" aria-label="anchor" href="#create-a-dev-branch-and-develop"></a>
</h3>
<p>You could <em>not</em> do this and just develop and push to
<code>main</code>. However, it is <em>really, really</em> useful to keep
a <code>main</code> branch that actually works. For instance, right now,
the <code>renv</code>, <code>dockerfile</code>, <code>CI</code> and
<code>pkgdown/gh-pages</code> all work. You might do something that
breaks any one of these, and debugging them is not easy. Being able to
revert to a working version, and then slowly re-integrate changes to
figure out what is causing the bug is far easier than making a big push
to <code>main</code>, breaking things, and then rolling back the git
history in <code>main</code> in my opinion.</p>
<ul>
<li>On your local, create a <code>dev</code> branch
(<code>git checkout -b dev</code>). At the very least, you’ll do your
work in the <code>dev</code> branch, and push changes to the remote
<code>dev</code>. You may choose to use other branches, also. But,
importantly, this way you’ll be able to do your development in
<code>dev</code> and choose when to merge it into <code>main</code>. It
will keep your <code>main</code> branch “clean”, meaning to the best of
your ability, your <code>main</code> branch will work. <code>dev</code>
may, on the otherhand, be unstable as you develop.
<ul>
<li>When you’re ready to merge from <code>dev</code> to
<code>main</code>, this will be the point at which you bump the <a href="https://semver.org/" class="external-link">semantic versioning</a> (you may choose to do
this throughout your <code>dev</code> branch developments – lots of
different methods here), rebuild the container(s), and create a
‘release’ on github. There should be an updated <code>CHANGELOG</code>
that goes along with any version bump.</li>
<li>If these instructions aren’t immediately clear and obvious, then you
need to stop and go read documentation and watch youtube videos on
<strong><em>BASIC</em></strong> git/github usage. This is a fundamental
skill in programming today, and has been for some time.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="writing-code">Writing code<a class="anchor" aria-label="anchor" href="#writing-code"></a>
</h2>
<p>First, if you aren’t writing tests along with your code, then you are
only doing half of your job. If you have any preconceived notions about
what tests are that make you think that you shouldn’t be writing tests,
then you need to get rid of those preconceived notions. They are also
wrong.</p>
<p><strong>The point of tests is to create a reproducible debugging
environment for you, and others, as you develop the codebase beyond your
first function</strong>. It allows you, or another developer, to easily
<em>at least</em> call your function, set a breakpoint at the first
line, and then step through line by line so that instead of relying on
your (probably shitty) documentation, the developer can actually see
what the code explicitely does.</p>
<p>The tests also serve as integration checks – when you add a new
function, it <em>should not</em> break an old function. The tests don’t
guarantee that this is true, but it is a good check to have even if you
shouldn’t trust blindly that passing a test is a bulletproof guarantee
of quality. That is something that you really always need to think
about.</p>
<p>Finally, because you do want a test suite that does provide some
assurance that the code is correct and works, improving the tests over
time is a lifetime-of-the-software goal – making the tests now serve as
a starting point for something that can be iteratively improved in the
future.</p>
<div class="section level3">
<h3 id="before-writing-any-code">Before writing any code<a class="anchor" aria-label="anchor" href="#before-writing-any-code"></a>
</h3>
<div class="section level4">
<h4 id="know-what-youre-doing">Know what you’re doing<a class="anchor" aria-label="anchor" href="#know-what-youre-doing"></a>
</h4>
<p>Before you have started this entire process, you knew what the goals
of this specific software is. If you don’t, stop and go figure that out
first.</p>
<p>If you know what the purpose of the software is, then you also know
what the ‘basic most fundamental’ tasks of this software will be, and
what that input data should look like because, as the developer, <em>you
decide what input and output are</em>. It is not decided by anyone else,
or the data. You decide.</p>
</div>
<div class="section level4">
<h4 id="get-some-development-data">Get some development data<a class="anchor" aria-label="anchor" href="#get-some-development-data"></a>
</h4>
<p>Before you do anything else, you need to get some data that you can
use for development. This should be as minimal as is reasonable to
actually write the code you need to write.</p>
<p>Put the data and put it either in <code>inst</code> or
<code>tmp</code> – if you put it in <code>inst</code>, then you can make
this data available in the package when it is distributed. If you put it
in <code>tmp</code>, then if you added this to your various
<code>ignore</code> files, you can prevent sharing that data outside of
your own local development space. This is useful if you are too lazy to
subset down the development data initially and just want to take what is
expedient and stick it in initially.</p>
</div>
<div class="section level4">
<h4 id="know-basic-style-conventions">Know basic style conventions<a class="anchor" aria-label="anchor" href="#know-basic-style-conventions"></a>
</h4>
<p>Read at least 1 of the style guides linked above in <a href="#user-setup">User setup</a>. Follow the style guide there in terms
of organizing your code. My preference is many, short code files that
are more or less divided by function and/or object and have the same
name as the function or class it contains. There are some R conventions
surrounding filenames – eg, <code>Clases.R</code>,
<code>methods.R</code>, <code>zzz.R</code> – you can get this kind of
information from the CRAN documentation on packaging, and also from the
Hadley/Bryan book.</p>
<p><strong><em>Use a linter</em></strong> The package <a href="https://styler.r-lib.org/" class="external-link">styler</a> is the most commonly used R
linter. Install this with</p>
</div>
</div>
<div class="section level3">
<h3 id="set-up-a-test-when-you-set-up-a-classfunction-script">Set up a test <em>when you set up a class/function script</em><a class="anchor" aria-label="anchor" href="#set-up-a-test-when-you-set-up-a-classfunction-script"></a>
</h3>
<p>I am going to follow my convention of 1 file to 1 function, both with
the same name.</p>
<ul>
<li>first, create a script file for the <code>prep_data</code> function
in the <code>R/</code> directory with `usethis::use_r(‘prep_data’)
<ul>
<li>This will open a file called <code>R/prep_data.R</code>.</li>
<li>Now call <code><a href="https://usethis.r-lib.org/reference/use_r.html" class="external-link">usethis::use_test()</a></code> which will, if you current
active window is <code>prep_data.R</code>, create a test for that
file.</li>
</ul>
</li>
<li>In the test, at least set up the input. So before writing anything
else, in the test, I do this:</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"prepare_data"</span>, <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># this is my development data, which I put in the `inst/` directory </span></span>
<span>  <span class="co"># where it will be installed, along with the package, when the package </span></span>
<span>  <span class="co"># is installed. This is how you access that data. Note that part of the </span></span>
<span>  <span class="co"># test suite is doing `library(&lt;your package&gt;)` prior to this -- `usethis` </span></span>
<span>  <span class="co"># handled this for you, so you don't see it in the actual specific test</span></span>
<span>  <span class="va">test_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'testing_gene_data.rds'</span>,</span>
<span>                package <span class="op">=</span> <span class="st">'brentlabModelPerfTesting'</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># I haven't written anything in the prep_data function! This will fail </span></span>
<span>  <span class="co"># until I do, which is a good thing.</span></span>
<span>  <span class="va">actual</span> <span class="op">=</span> <span class="fu"><a href="../reference/prep_data.html">prep_data</a></span><span class="op">(</span><span class="va">test_data</span>, <span class="fl">10</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># just placeholder for now</span></span>
<span>  <span class="va">expected</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">test_data</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">expect_identical</span><span class="op">(</span><span class="va">expected</span>, <span class="va">actual</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>In the function, I might now write something like this – Note that I
start writing the documentation now! Also, to handle importing packages,
we are using <code>roxygen2</code> – that is what the
<code>@importFrom</code> statement is doing. You can read more about
this in the Wickam/Bryan Packaging R book, and in the
<code>roxygen2</code> docs. If you don’t know how to manage dependencies
this way, then you need to stop and go read about it now.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#' prep data for the testing functions</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @importFrom assertthat assert_that</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param gene_data a data.frame where the label_vector column is the response</span></span>
<span><span class="co">#'   and the rest of the columns are predictors</span></span>
<span><span class="co">#' @param feature_num is the number of feature_num to select from the data. must be</span></span>
<span><span class="co">#'   $&gt;=$ 1.If exceeds ncol, ncol-1 is used (1 col removed as the label).</span></span>
<span><span class="co">#'   Default is to use all columns</span></span>
<span><span class="co">#' @param label_vector name of the column to use as the response</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">prep_data</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">gene_data</span>,</span>
<span>    <span class="va">feature_num</span> <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>    <span class="va">label_vector</span> <span class="op">=</span> <span class="st">'ensg00000183117_19'</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu">assertthat</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/assertthat/man/assert_that.html" class="external-link">assert_that</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">feature_num</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">assertthat</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/assertthat/man/assert_that.html" class="external-link">assert_that</a></span><span class="op">(</span><span class="op">(</span><span class="va">label_vector</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">gene_data</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># return this out -- this is just a placeholder for development</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">gene_data</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And run the test via that same panel from which you ran the
<code>check</code>. Maybe it works, maybe it doesn’t, but at least now
you have a framework in which you can make your developing
reproducible.</p>
</div>
<div class="section level3">
<h3 id="interactive-development">Interactive development<a class="anchor" aria-label="anchor" href="#interactive-development"></a>
</h3>
<p>In python, you can use <code>pip install -e .</code> to install a
development package from its <code>src</code> directory (the one where
you’re working) so that any changes you make are immediately present in
your <code>PYTHONPATH</code>. In R, you can do something similar with
<code>devtools::load_all()</code>. <strong><em>But</em></strong> this
needs to be re-done each time you make a change. Do this now.</p>
<div class="section level4">
<h4 id="set-a-breakpoint">Set a breakpoint<a class="anchor" aria-label="anchor" href="#set-a-breakpoint"></a>
</h4>
<ul>
<li>
<strong>In <code>prep_data</code>, set a breakpoint</strong>. Maybe
set it on the first line, so that no code is executed inside of hte
function, and you stop in an interactive environment in which you can
execute the code/write/etc in the console with the actual function
data.</li>
</ul>
</div>
<div class="section level4">
<h4 id="installing-dependencies">Installing dependencies<a class="anchor" aria-label="anchor" href="#installing-dependencies"></a>
</h4>
<p>To install dependencies, we’re going to use
<code><a href="https://usethis.r-lib.org/reference/use_package.html" class="external-link">usethis::use_package</a></code>. Read the docs on this – you will be
able to decide what section the package gets added to
(<code>Imports</code>, <code>Suggests</code>, <code>Depends</code>). I
typically set <code>min_version = TRUE</code>, but put thought into
this, generally. <strong><em>Important</em></strong> remember to update
your virtual environment frequently – to see the changes, use
<code><a href="https://rstudio.github.io/renv/reference/status.html" class="external-link">renv::status()</a></code>. To update the lockfile, do
<code><a href="https://rstudio.github.io/renv/reference/snapshot.html" class="external-link">renv::snapshot()</a></code>. Be aware of what you’re doing – don’t
fill your environment with a bunch of junk (though, if you do this,
<code>renv</code> does have some functions to help clean things up).</p>
<div class="section level5">
<h5 id="installing-from-a-remote-other-than-cran-or-bioconductor">Installing from a remote other than CRAN or Bioconductor<a class="anchor" aria-label="anchor" href="#installing-from-a-remote-other-than-cran-or-bioconductor"></a>
</h5>
<p>For example, I want this package to depend on a pre-compiled version
of XGBoost which is distributed by XGBoost, but not on CRAN.</p>
<p>this is how this is done:</p>
<ul>
<li>First, based on the <a href="https://remotes.r-lib.org/articles/dependencies.html#other-sources" class="external-link">Remotes</a>
documentation, add the following to the <code>DESCRIPTION</code>
file:</li>
</ul>
<pre class="raw"><code>Remotes: 
  xgboost=url::https://github.com/dmlc/xgboost/releases/download/v1.7.2/xgboost_r_gpu_linux_1.7.2.tar.gz</code></pre>
<ul>
<li><p>Then, use <code>renv</code> to install, in this case,
<code>xgboost</code> – it will respect the <code>Remotes</code> field in
DESCRIPTION.</p></li>
<li><p>Next, use <code>usethis</code> to add <code>xgboost</code>, in
this case, to the DESCRIPTION <code>Imports</code>:
<code>usethis::use_package('xgboost', min_version=TRUE)</code></p></li>
<li><p>Update the virtual environment: <code><a href="https://rstudio.github.io/renv/reference/status.html" class="external-link">renv::status()</a></code> –
just take a look at what changed, make sure you agree. Then
<code><a href="https://rstudio.github.io/renv/reference/snapshot.html" class="external-link">renv::snapshot()</a></code>.</p></li>
</ul>
<p>As a side note, this is what the <code>renv.lock</code> file entry
for xgboost looks like:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="er">...</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="er">"xgboost":</span> <span class="fu">{</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"Package"</span><span class="fu">:</span> <span class="st">"xgboost"</span><span class="fu">,</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"Version"</span><span class="fu">:</span> <span class="st">"1.7.2.1"</span><span class="fu">,</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"Source"</span><span class="fu">:</span> <span class="st">"URL"</span><span class="fu">,</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"RemoteType"</span><span class="fu">:</span> <span class="st">"url"</span><span class="fu">,</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"RemoteUrl"</span><span class="fu">:</span> <span class="st">"https://github.com/dmlc/xgboost/releases/download/v1.7.2/xgboost_r_gpu_linux_1.7.2.tar.gz"</span><span class="fu">,</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"Hash"</span><span class="fu">:</span> <span class="st">"d6328ccd7dbb29c1c1c285b045083e02"</span><span class="fu">,</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"Requirements"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Matrix"</span><span class="ot">,</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"data.table"</span><span class="ot">,</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"jsonlite"</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="er">,</span> </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="er">...</span></span></code></pre></div>
</div>
</div>
<div class="section level4">
<h4 id="iterate-and-develop">Iterate and develop<a class="anchor" aria-label="anchor" href="#iterate-and-develop"></a>
</h4>
<p>write, set a breakpoint, execute to the breakpoint, write,
<strong>and critically</strong> simultaneously update the test</p>
</div>
<div class="section level4">
<h4 id="result">Result<a class="anchor" aria-label="anchor" href="#result"></a>
</h4>
<p>By doing this process, I end up with a test that looks like this:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"prepare_data"</span>, <span class="op">{</span></span>
<span>  <span class="va">test_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'testing_gene_data.rds'</span>,</span>
<span>                package <span class="op">=</span> <span class="st">'brentlabModelPerfTesting'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="op">{</span><span class="va">prepped_data_subset</span> <span class="op">=</span> <span class="fu"><a href="../reference/prep_data.html">prep_data</a></span><span class="op">(</span><span class="va">test_data</span>, <span class="fl">10</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">prepped_data_subset</span><span class="op">$</span><span class="va">train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span><span class="op">*</span><span class="fl">.8</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="op">{</span><span class="va">prepped_data_default</span> <span class="op">=</span> <span class="fu"><a href="../reference/prep_data.html">prep_data</a></span><span class="op">(</span><span class="va">test_data</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">prepped_data_default</span><span class="op">$</span><span class="va">train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span><span class="op">*</span><span class="fl">.8</span>,<span class="fl">19</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>And a function that looks like this:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#' prep data for the testing functions</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @importFrom assertthat assert_that</span></span>
<span><span class="co">#' @importFrom rsample initial_split training testing</span></span>
<span><span class="co">#' @importFrom xgboost xgb.DMatrix</span></span>
<span><span class="co">#' @importFrom dplyr select all_of</span></span>
<span><span class="co">#' @import futile.logger</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param gene_data a data.frame where the label_vector column is the response</span></span>
<span><span class="co">#'   and the rest of the columns are predictors</span></span>
<span><span class="co">#' @param feature_num is the number of feature_num to select from the data. must be</span></span>
<span><span class="co">#'   $&gt;=$ 1.If exceeds ncol, ncol-1 is used (1 col removed as the label).</span></span>
<span><span class="co">#'   Default is to use all columns</span></span>
<span><span class="co">#' @param label_vector name of the column to use as the response</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return a list with xgboost data matrix objects, slots dtrain, dtest and wl</span></span>
<span><span class="co">#'   see the xgboost docs on wl. dtrain is the trainin data to</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#'   test_data = readRDS(</span></span>
<span><span class="co">#'       system.file('testing_gene_data.rds',</span></span>
<span><span class="co">#'       package = 'brentlabModelPerfTesting'))</span></span>
<span><span class="co">#'   # note: suppressed warnings used here b/c the test data is too</span></span>
<span><span class="co">#'   # small to stratify. Typically, do not use supressWarnings.</span></span>
<span><span class="co">#'   suppressWarnings({prepped_data_subset = brentlabModelPerfTesting::prep_data(test_data, 10)})</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#'   names(prepped_data_subset)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">prep_data</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">gene_data</span>,</span>
<span>    <span class="va">feature_num</span> <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>    <span class="va">label_vector</span> <span class="op">=</span> <span class="st">'ensg00000183117_19'</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="fu">assertthat</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/assertthat/man/assert_that.html" class="external-link">assert_that</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">feature_num</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">assertthat</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/assertthat/man/assert_that.html" class="external-link">assert_that</a></span><span class="op">(</span><span class="op">(</span><span class="va">label_vector</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">gene_data</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">gene_data_split</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">initial_split</a></span><span class="op">(</span></span>
<span>    <span class="va">gene_data</span>,</span>
<span>    prop <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>    strata <span class="op">=</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/sym.html" class="external-link">sym</a></span><span class="op">(</span><span class="va">label_vector</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">feature_num</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">feature_num</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">flog.info</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'creating train test data with '</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">gene_data</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>, <span class="va">feature_num</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="st">' predictor variables'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># prepare the input data -- subset number of feature_num to</span></span>
<span>  <span class="co"># test effect of feature_num on runtime/performance</span></span>
<span>  <span class="va">train_dat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">training</a></span><span class="op">(</span><span class="va">gene_data_split</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>                          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu">all_of</span><span class="op">(</span><span class="va">label_vector</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>                          <span class="va">.</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">gene_data</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>, <span class="va">feature_num</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">test_dat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">testing</a></span><span class="op">(</span><span class="va">gene_data_split</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>                         <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu">all_of</span><span class="op">(</span><span class="va">label_vector</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="va">.</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">gene_data_split</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>,<span class="va">feature_num</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># common for all test iterations -- not testing effect of number of samples</span></span>
<span>  <span class="va">train_labels</span> <span class="op">=</span> <span class="fu">training</span><span class="op">(</span><span class="va">gene_data_split</span><span class="op">)</span><span class="op">[[</span><span class="va">label_vector</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">test_labels</span> <span class="op">=</span> <span class="fu">testing</span><span class="op">(</span><span class="va">gene_data_split</span><span class="op">)</span><span class="op">[[</span><span class="va">label_vector</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># return data for xgboost input</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    train <span class="op">=</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html" class="external-link">xgb.DMatrix</a></span><span class="op">(</span><span class="va">train_dat</span>, label <span class="op">=</span> <span class="va">train_labels</span><span class="op">)</span>,</span>
<span>    test <span class="op">=</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html" class="external-link">xgb.DMatrix</a></span><span class="op">(</span><span class="va">test_dat</span>, label<span class="op">=</span><span class="va">test_labels</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="check-locally">Check locally<a class="anchor" aria-label="anchor" href="#check-locally"></a>
</h4>
<ul>
<li><p>In the same tab in the Rstudio pane where you did the
<code>check</code>, run the <code>Test</code> tab – make sure those pass
first. Debug if necessary.</p></li>
<li><p>Check your documentation format with
<code>roxygen2::roxygenise()</code>. Debug if necessary.</p></li>
<li><p>Then, run the <code>check</code> this locally (from the
Environment/Build pane in Rstudio), as we did before with just the
boilerplate code. Debug if necessary.</p></li>
</ul>
</div>
<div class="section level4">
<h4 id="push-to-github">Push to github<a class="anchor" aria-label="anchor" href="#push-to-github"></a>
</h4>
<p>Where you push this is your choice – if your on the <code>dev</code>
branch, push to <code>dev</code>. If your on <code>main</code>, push to
<code>main</code>. Maybe merge <code>dev</code> to <code>main</code>
locally, or you could push to <code>dev</code> and issue a pull request
to <code>main</code>. On github, the CI will run – make sure that
passes. If it doesn’t debug.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>From this point, you can look at the repo and see what I’ve done
beyond this – more or less just adding a single additional function, and
writing the cmd line interface (which is in <code>inst</code>). You
should see the vignette <code>Using_Package_Data</code> for some
comments on including data in the project. See <code>Usage</code> for
instrutions on using both the cmd line script and the container. See
performance_testing_xgboost_on_htcf for results of performance testing
by varying the parameters which affect runtime/memory on both CPUs
(various numbers of cpus) the GPU. This also examines the scheduling
rate on both CPU and GPU batch runs on HTCF.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Mateusiak Chase.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
